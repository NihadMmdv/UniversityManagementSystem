<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMS - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-mortarboard-fill"></i> UMS</a>
            <div class="d-flex align-items-center gap-2">
                <span class="text-white me-2" id="userName"></span>
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="langToggleBtn">🇦🇿 Azərbaycanca</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="changePasswordBtn"><i class="bi bi-key-fill me-2"></i><span data-i18n="nav.changePassword">Change Password</span></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i><span data-i18n="nav.logout">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row g-4">
            <!-- Left: Content -->
            <div class="col-lg-8">
                <div class="text-center mb-4">
                    <h1 class="display-5" data-i18n="landing.welcome">Welcome to UMS</h1>
                    <p class="lead text-muted" data-i18n="landing.subtitle">Your academic portal for courses, schedules, and more.</p>
                </div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <a href="courses.html" class="text-decoration-none">
                            <div class="card h-100 shadow-sm course-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-book-fill display-3 text-primary"></i>
                                    <h4 class="mt-3 text-dark" data-i18n="landing.courses">Courses</h4>
                                    <p class="text-muted" data-i18n="landing.coursesDesc">Browse available lessons and course materials.</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 d-none" id="examsCard">
                        <a href="exams.html" class="text-decoration-none">
                            <div class="card h-100 shadow-sm course-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-pencil-square display-3 text-danger"></i>
                                    <h4 class="mt-3 text-dark" data-i18n="landing.exams">Exams</h4>
                                    <p class="text-muted" data-i18n="landing.examsDesc">View your exam results and scores.</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="schedule.html" class="text-decoration-none">
                            <div class="card h-100 shadow-sm course-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-calendar-event-fill display-3 text-success"></i>
                                    <h4 class="mt-3 text-dark" data-i18n="landing.schedule">Schedule</h4>
                                    <p class="text-muted" data-i18n="landing.scheduleDesc">View your class schedule and exam dates.</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 d-none" id="materialsCard">
                        <a href="materials.html" class="text-decoration-none">
                            <div class="card h-100 shadow-sm course-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-file-earmark-arrow-up-fill display-3 text-warning"></i>
                                    <h4 class="mt-3 text-dark" data-i18n="landing.materials">Materials</h4>
                                    <p class="text-muted" data-i18n="landing.materialsDesc">Upload teaching materials and exam questions for your lessons.</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right: Profile Card -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <img id="profilePhoto" src="" alt="Profile Photo"
                             class="rounded-circle mb-3 border border-3 border-primary"
                             style="width:120px;height:120px;object-fit:cover;"
                             onerror="this.src='https://ui-avatars.com/api/?name=U&background=0d6efd&color=fff&size=120'">
                        <h4 id="profileName" class="mb-1"></h4>
                        <span class="badge bg-primary mb-3" id="profileRole"></span>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted"><i class="bi bi-envelope me-2"></i><span data-i18n="label.email">Email</span></span>
                            <span id="profileEmail"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted"><i class="bi bi-phone me-2"></i><span data-i18n="label.phone">Phone</span></span>
                            <span id="profilePhone"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span class="text-muted"><i class="bi bi-calendar me-2"></i><span data-i18n="label.birthDate">Birth Date</span></span>
                            <span id="profileDob"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between" id="profileClassRow" style="display:none!important">
                            <span class="text-muted"><i class="bi bi-grid-fill me-2"></i><span data-i18n="label.class">Class</span></span>
                            <span id="profileClass"></span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" data-i18n="modal.password.title">Change Password</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-3"><label class="form-label" data-i18n="modal.password.current">Current Password</label><input type="password" class="form-control" id="currentPassword" required></div>
            <div class="mb-3"><label class="form-label" data-i18n="modal.password.new">New Password</label><input type="password" class="form-control" id="newPassword" required></div>
            <div class="mb-3"><label class="form-label" data-i18n="modal.password.confirm">Confirm New Password</label><input type="password" class="form-control" id="confirmPassword" required></div>
            <div class="alert alert-danger d-none" id="passwordError"></div>
            <div class="alert alert-success d-none" id="passwordSuccess" data-i18n="modal.password.success">Password changed successfully!</div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="btn.cancel">Cancel</button><button class="btn btn-primary" id="savePasswordBtn" data-i18n="btn.save">Save</button></div>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/api.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const store = localStorage.getItem('token') ? localStorage : sessionStorage;
        const token = store.getItem('token');

        if (!token) { window.location.href = 'index.html'; return; }
        if (store.getItem('userRole') === 'Admin') { window.location.href = 'dashboard.html'; return; }

        document.getElementById('userName').textContent = store.getItem('userName') || store.getItem('userEmail');

        // Load profile
        try {
            const profile = await api.get('Auth/me');
            if (!profile) return;

            const fullName = `${profile.name} ${profile.surname || ''}`.trim();
            document.getElementById('profilePhoto').src = profile.photoUrl
                || `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=0d6efd&color=fff&size=120`;
            document.getElementById('profileName').textContent = fullName;
            document.getElementById('profileRole').textContent = profile.role;
            document.getElementById('profileEmail').textContent = profile.email;
            document.getElementById('profilePhone').textContent = profile.phone || '-';
            document.getElementById('profileDob').textContent = profile.dateOfBirth || '-';

            if (profile.className) {
                document.getElementById('profileClassRow').style.display = '';
                document.getElementById('profileClassRow').classList.add('d-flex');
                document.getElementById('profileClass').textContent = profile.className;
            }

            // Show Exams card only for students
            if (profile.role === 'Student') {
                document.getElementById('examsCard').classList.remove('d-none');
            }

            // Show Materials card only for teachers
            if (profile.role === 'Teacher') {
                document.getElementById('materialsCard').classList.remove('d-none');
            }
        } catch (e) { console.error('Failed to load profile', e); }
    });

    // Change Password
    document.getElementById('changePasswordBtn').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordError').classList.add('d-none');
        document.getElementById('passwordSuccess').classList.add('d-none');
        new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
    });

    document.getElementById('savePasswordBtn').addEventListener('click', async () => {
        const errorDiv = document.getElementById('passwordError');
        const successDiv = document.getElementById('passwordSuccess');
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');

        const newPass = document.getElementById('newPassword').value;
        const confirmVal = document.getElementById('confirmPassword').value;

        if (newPass !== confirmVal) {
            errorDiv.textContent = t('modal.password.mismatch');
            errorDiv.classList.remove('d-none');
            return;
        }
        if (newPass.length < 6) {
            errorDiv.textContent = t('modal.password.tooShort');
            errorDiv.classList.remove('d-none');
            return;
        }

        try {
            await api.post('Auth/change-password', {
                currentPassword: document.getElementById('currentPassword').value,
                newPassword: newPass
            });
            successDiv.classList.remove('d-none');
            setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide(), 1500);
        } catch (e) {
            errorDiv.textContent = t('modal.password.incorrect');
            errorDiv.classList.remove('d-none');
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); logout(); });
    </script>
</body>
</html>